<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="description" content="Reasoning about Laravel, PHP, Vue.js, JavaScript and sharing all along. Guilherme Caraciolo.">

        <meta property="og:title" content="Unreliable Laravel SQS Queue | Guilherme Caraciolo on Laravel"/>
        <meta property="og:url" content="https://gcaraciolo.github.io/blog/en/unreliable-laravel-sqs-queue"/>
        <meta property="og:description" content="Reasoning about Laravel, PHP, Vue.js, JavaScript and sharing all along. Guilherme Caraciolo." />

        <title>Unreliable Laravel SQS Queue | Guilherme Caraciolo on Laravel</title>

        <link rel="home" href="https://gcaraciolo.github.io">
        <link rel="icon" href="/favicon.ico">
        <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="Guilherme Caraciolo on Laravel Atom Feed">

                    <!-- Insert analytics code here -->
        
        <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
        <link rel="stylesheet" href="/assets/build/css/main.css?id=573e9e9c3898b16556b274a4d9f13e7f">
    </head>

    <body class="flex flex-col justify-between min-h-screen bg-white text-gray-800 leading-normal">
        <main role="main" class="flex-auto w-full container max-w-4xl mx-auto py-16 px-6">
                <div class="max-w-2xl mx-auto">
        <a href="/" class="cursor-pointer">
    <div class="text-center flex flex-col items-center">
        <div class=""><img class="rounded-full h-24 w-24" src="/assets/img/avatar.png" alt="avatar"></div>
        <p class="text-2xl text-gray-700">Guilherme Caraciolo</p>
    </div>
</a>
        <div class="text-center mt-12">
            <p class="text-gray-400 text-sm my-2">February 5, 2022</p>
            <h1 class="leading-none mb-8 text-4xl font-semibold">Unreliable Laravel SQS Queue</h1>
        </div>

        <div class="mb-10 py-4 text-justify" v-pre>
            <article
    class="prose dark:prose-invert prose-a:no-underline prose-a:font-bold prose-a:border-b-[#7dd3fc] prose-a:border-b max-w-none">
    <p>Recently I was trying to understanding why some Laravel Jobs weren't being executed. Looking at the failed jobs
I realized that some jobs haven't even started in the first place, which made me thought that the problem wasn't
in my code.</p>

<p>So I decided to create a fresh Proof of Concept (PoC) Laravel project to dig deeper, with the goal to understand how
Laravel decides when a job should be processed or not.</p>

<p>The PoC is simple enough. 2 Models, 1 Controller, 1 Job and 1 Command. One <code>Deposit</code> model with an <code>amount</code> column and one <code>Balance</code> model with also an <code>amount</code> column. When a request arrives at the controller, it should register a new <code>deposit</code> and dispatch a job to synchronize the <code>balannce</code>. The Job should increment that <code>deposit</code> in the balance asynchronously as this consumes more from the database due to the integrity check necessary to the operation. The goal of the command is to show infos about queue and database data.</p>

<p>It'll also be necessary an AWS account with an Standard SQS setup. I will assume you know how to do this.
And I recommend to put this app under Nginx to accept concurrent requests.</p>

<p>Ok, lets setup the environment.</p>

<h1>Setup</h1>

<p>First run this commands to create a fresh Laravel project with all required dependencies.</p>

<pre><code>__torchlight-block-[670d92cf-a2ee-4783-bd02-6c183bb4aa81]__</code></pre>

<p>Change these file contents:</p>

<p><em>create_deposits_table.php</em></p>

<pre><code class="language-php">__torchlight-block-[ffe11688-dac2-4525-97e7-ab1e4d416af1]__</code></pre>

<p><em>create_balances_table.php</em></p>

<pre><code class="language-php">__torchlight-block-[bf218767-fe74-4469-85e2-ae1ba71d264e]__</code></pre>

<p><em>routes/api.php</em></p>

<pre><code class="language-php">__torchlight-block-[dfb6a74f-4cab-4852-9a7d-878ef589035e]__</code></pre>

<p><strong>Disable api throttle middleware</strong><br />
<em>Http/Kernel.php</em></p>

<pre><code class="language-php">__torchlight-block-[15eaf484-7881-4c1a-bac4-03eaa48bfcb7]__</code></pre>

<p><em>DepositController.php</em></p>

<pre><code class="language-php">__torchlight-block-[f225922a-ee23-4502-832c-24c170e56288]__</code></pre>

<p><em>Deposit.php</em></p>

<pre><code class="language-php">__torchlight-block-[6f73fbec-f955-486c-990b-17c6579262b6]__</code></pre>

<p><em>Balance.php</em></p>

<pre><code class="language-php">__torchlight-block-[c7be48e4-94de-4ad7-83a3-d9e2a204fc37]__</code></pre>

<p><em>SyncBalanceJob.php</em></p>

<pre><code class="language-php">__torchlight-block-[e9a3c1b6-f31e-4ffb-b53d-1bcfda3a45fc]__</code></pre>

<p><em>DataMonitorCommand.php</em></p>

<pre><code class="language-php">__torchlight-block-[8ad9ec1a-0afe-49e9-8ac8-a32321a5b45f]__</code></pre>

<p>Change this environment variables
<em>.env</em></p>

<pre><code>__torchlight-block-[4f0a2238-f911-4b84-894d-5b048d656ccc]__</code></pre>

<p>Run migrations</p>

<pre><code>__torchlight-block-[6f2001c7-0917-45eb-8daf-5b141925a9ac]__</code></pre>

<h1>Exposing the problem</h1>

<p>Alright.. let's see some erros! Open your terminal and split it into six views.<br />
4 views for laravel works</p>

<pre><code>__torchlight-block-[12ff9c2a-7539-45f0-91bf-1e96b89ff28d]__</code></pre>

<p>1 view for data monitoring</p>

<pre><code>__torchlight-block-[daf40b69-d501-4415-919f-e3d02009a2df]__</code></pre>

<p>1 view to send requests. Use this command to send 1000 requests to deposit $100 with 10 requests in parallel:</p>

<pre><code>__torchlight-block-[626755c2-cb51-430f-9a53-22a16b31c124]__</code></pre>

<p>Soon enough some jobs will start to fail and your balance will be corrupted. <strong>What a shame!</strong></p>

<p>{{&lt; figure src="/laravel-queue-fail.gif" alt="Multiple terminals opened" caption="Laravel jogs running in parallel" >}}</p>

<p>My final data was:</p>

<table>
<thead>
<tr>
  <th>queue-size</th>
  <th>balance</th>
  <th>sum deposits</th>
</tr>
</thead>
<tbody>
<tr>
  <td>0</td>
  <td>94000</td>
  <td>100000</td>
</tr>
</tbody>
</table>

<p><strong>A 0.06% of rating error.</strong></p>

<h1>Digging Deeper</h1>

<p>First thing I looked at was the <code>laravel.log</code> file to see the stack trace of the error. But no errros were found.
Well, this is just that the Job failed before it even execute my code. I've used Laravel Telescope to see the error and found the message:</p>

<pre><code>__torchlight-block-[410d6d73-7892-4dce-a798-e8a1f1dd6cb5]__</code></pre>

<p>But how come! The job haven't even been executed. How can it be attempted too many times or even ran too long?</p>

<p>Let's dig deeper into Laravels framework!<br />
Jump to <code>laravel/framework/src/Illuminate/Queue/Worker.php:504</code>
and add a print statement just before the exception is raised, line 503</p>

<pre><code class="language-php">__torchlight-block-[7929b136-625e-4541-b566-7abd1b4643de]__</code></pre>

<p>Repeat the steps on <code>exposing the problem</code> and wait a job to fail. Then jump again to <code>laravel.log</code> and youÂ´ll probably see something like:</p>

<pre><code>__torchlight-block-[069bf441-3ac0-477b-80b1-ed7d6f089965]__</code></pre>

<p><code>$job-&gt;attempts()</code> returned 2 and the job could only be executed once.. uh... intersting.. How Laravel decides how many times a SQS messagem was delivered?</p>

<p>Jump to <code>laravel/framework/src/Illuminate/Queue/Jobs/SqsJob.php:81</code>.</p>

<pre><code class="language-php">__torchlight-block-[6217a9bb-9c04-4bba-863a-348a9221aa9c]__</code></pre>

<p>So... Laravel SQS Job uses AWS SQS messagem <code>ApproximateReceiveCount</code> to decide if a job was executed or not. What does <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_ReceiveMessage.html">AWS SQS Docs</a> says about this property?</p>

<pre><code>__torchlight-block-[cc65fb6e-9f83-4777-834e-b7000748ece4]__</code></pre>

<p>It seems the right thing, but.. SQS itself is a service that promises <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_GetQueueAttributes.html">eventual consistency</a>! And the parameter itself says <code>Approximate</code>..</p>

<p>Knowing this we can't rely on this attribute. Indeed, a best practice is to make our job <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a> so it can be executed many times but always produce the same result.</p>

<h1>Fixing the problem</h1>

<p>First thing to do is to tell Laravel that our job could be executed many times, using the <code>$tries</code> property of the job.</p>

<p><em>SyncBalanceJob.php</em></p>

<pre><code class="language-php">__torchlight-block-[b3530cd2-26d3-4b03-be01-36853082d6e5]__</code></pre>

<p>Next, we shall make sure that this job is idempotent. We can't just rely that it will execute only once after had failed.. the caoes theory says that if something could go wrong, in a large environment, it'll certanly go wrong.</p>

<p>The easiest way to do this is adding a <code>sync_at</code> column in the <code>Deposit</code> model and wrap the sync balance operation in a transaction:</p>

<p><em>SyncBalanceJob.php</em></p>

<pre><code class="language-php">__torchlight-block-[4b75972d-262a-43ab-a20c-006fb8533f4b]__</code></pre>

<p><em>Deposit.php</em></p>

<pre><code class="language-php">__torchlight-block-[8bb4e5b1-ff9c-4d8b-9f83-d1bbe0598021]__</code></pre>

<p><em>create_deposits_table.php</em></p>

<pre><code class="language-php">__torchlight-block-[48bcae41-d1b2-40f6-bb1d-bbc1cfd323e5]__</code></pre>

<p>And now everything should work properly. :D</p>
</article>
        </div>
        <div class="border-b border-b-gray-200 mb-8"></div>

        <p class="text-lg text-center text-gray-700">Guilherme Caraciolo</p>
        <div class="text-center flex flex-col items-center">
    <p class="text-gray-700">Software Engineer</p>
    <p class="text-gray-700 py-4">
        Reasoning about Laravel, VueJS and programming in general.
    </p>
    <div class="flex gap-6">
        <a target="_blank" class="group -m-1 p-1" aria-label="Follow on Twitter" href="https://twitter.com/gcaraciolo">
            <svg viewBox="0 0 24 24" aria-hidden="true"
                class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300">
                <path
                    d="M20.055 7.983c.011.174.011.347.011.523 0 5.338-3.92 11.494-11.09 11.494v-.003A10.755 10.755 0 0 1 3 18.186c.308.038.618.057.928.058a7.655 7.655 0 0 0 4.841-1.733c-1.668-.032-3.13-1.16-3.642-2.805a3.753 3.753 0 0 0 1.76-.07C5.07 13.256 3.76 11.6 3.76 9.676v-.05a3.77 3.77 0 0 0 1.77.505C3.816 8.945 3.288 6.583 4.322 4.737c1.98 2.524 4.9 4.058 8.034 4.22a4.137 4.137 0 0 1 1.128-3.86A3.807 3.807 0 0 1 19 5.274a7.657 7.657 0 0 0 2.475-.98c-.29.934-.9 1.729-1.713 2.233A7.54 7.54 0 0 0 22 5.89a8.084 8.084 0 0 1-1.945 2.093Z">
                </path>
            </svg>
        </a>
        <a target="_blank" class="group -m-1 p-1" aria-label="Follow on Instagram" href="https://instagram.com/gcaraciolo">
            <svg viewBox="0 0 24 24" aria-hidden="true"
                class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300">
                <path
                    d="M12 3c-2.444 0-2.75.01-3.71.054-.959.044-1.613.196-2.185.418A4.412 4.412 0 0 0 4.51 4.511c-.5.5-.809 1.002-1.039 1.594-.222.572-.374 1.226-.418 2.184C3.01 9.25 3 9.556 3 12s.01 2.75.054 3.71c.044.959.196 1.613.418 2.185.23.592.538 1.094 1.039 1.595.5.5 1.002.808 1.594 1.038.572.222 1.226.374 2.184.418C9.25 20.99 9.556 21 12 21s2.75-.01 3.71-.054c.959-.044 1.613-.196 2.185-.419a4.412 4.412 0 0 0 1.595-1.038c.5-.5.808-1.002 1.038-1.594.222-.572.374-1.226.418-2.184.044-.96.054-1.267.054-3.711s-.01-2.75-.054-3.71c-.044-.959-.196-1.613-.419-2.185A4.412 4.412 0 0 0 19.49 4.51c-.5-.5-1.002-.809-1.594-1.039-.572-.222-1.226-.374-2.184-.418C14.75 3.01 14.444 3 12 3Zm0 1.622c2.403 0 2.688.009 3.637.052.877.04 1.354.187 1.67.31.421.163.72.358 1.036.673.315.315.51.615.673 1.035.123.317.27.794.31 1.671.043.95.052 1.234.052 3.637s-.009 2.688-.052 3.637c-.04.877-.187 1.354-.31 1.67-.163.421-.358.72-.673 1.036a2.79 2.79 0 0 1-1.035.673c-.317.123-.794.27-1.671.31-.95.043-1.234.052-3.637.052s-2.688-.009-3.637-.052c-.877-.04-1.354-.187-1.67-.31a2.789 2.789 0 0 1-1.036-.673 2.79 2.79 0 0 1-.673-1.035c-.123-.317-.27-.794-.31-1.671-.043-.95-.052-1.234-.052-3.637s.009-2.688.052-3.637c.04-.877.187-1.354.31-1.67.163-.421.358-.72.673-1.036.315-.315.615-.51 1.035-.673.317-.123.794-.27 1.671-.31.95-.043 1.234-.052 3.637-.052Z">
                </path>
                <path
                    d="M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm0-7.622a4.622 4.622 0 1 0 0 9.244 4.622 4.622 0 0 0 0-9.244Zm5.884-.182a1.08 1.08 0 1 1-2.16 0 1.08 1.08 0 0 1 2.16 0Z">
                </path>
            </svg>
        </a>
        <a target="_blank" class="group -m-1 p-1" aria-label="Follow on GitHub" href="https://github.com/gcaraciolo">
            <svg viewBox="0 0 24 24" aria-hidden="true"
                class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M12 2C6.475 2 2 6.588 2 12.253c0 4.537 2.862 8.369 6.838 9.727.5.09.687-.218.687-.487 0-.243-.013-1.05-.013-1.91C7 20.059 6.35 18.957 6.15 18.38c-.113-.295-.6-1.205-1.025-1.448-.35-.192-.85-.667-.013-.68.788-.012 1.35.744 1.538 1.051.9 1.551 2.338 1.116 2.912.846.088-.666.35-1.115.638-1.371-2.225-.256-4.55-1.14-4.55-5.062 0-1.115.387-2.038 1.025-2.756-.1-.256-.45-1.307.1-2.717 0 0 .837-.269 2.75 1.051.8-.23 1.65-.346 2.5-.346.85 0 1.7.115 2.5.346 1.912-1.333 2.75-1.05 2.75-1.05.55 1.409.2 2.46.1 2.716.637.718 1.025 1.628 1.025 2.756 0 3.934-2.337 4.806-4.562 5.062.362.32.675.936.675 1.897 0 1.371-.013 2.473-.013 2.82 0 .268.188.589.688.486a10.039 10.039 0 0 0 4.932-3.74A10.447 10.447 0 0 0 22 12.253C22 6.588 17.525 2 12 2Z">
                </path>
            </svg>
        </a>
        <a target="_blank" class="group -m-1 p-1" aria-label="Follow on LinkedIn" href="https://www.linkedin.com/in/guilherme-caraciolo-52485999/">
            <svg viewBox="0 0 24 24" aria-hidden="true"
                class="h-6 w-6 fill-zinc-500 transition group-hover:fill-zinc-600 dark:fill-zinc-400 dark:group-hover:fill-zinc-300">
                <path
                    d="M18.335 18.339H15.67v-4.177c0-.996-.02-2.278-1.39-2.278-1.389 0-1.601 1.084-1.601 2.205v4.25h-2.666V9.75h2.56v1.17h.035c.358-.674 1.228-1.387 2.528-1.387 2.7 0 3.2 1.778 3.2 4.091v4.715zM7.003 8.575a1.546 1.546 0 01-1.548-1.549 1.548 1.548 0 111.547 1.549zm1.336 9.764H5.666V9.75H8.34v8.589zM19.67 3H4.329C3.593 3 3 3.58 3 4.297v15.406C3 20.42 3.594 21 4.328 21h15.338C20.4 21 21 20.42 21 19.703V4.297C21 3.58 20.4 3 19.666 3h.003z">
                </path>
            </svg>
        </a>
    </div>
</div>
    </div>
        </main>

        <script src="/assets/build/js/main.js?id=b7a53903c7901b49880ccb30ec0c429f"></script>

            </body>
</html>
